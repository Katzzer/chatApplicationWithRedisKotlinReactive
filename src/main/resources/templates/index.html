<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="/redis.ico">
    <link rel="stylesheet" href="/css/chat-styles.css">
    <title>Redis Chat Application Demo</title>
  </head>
  <body>
    <div class="chat-container">
      <div class="chat-header">
        <h1>Redis Chat Application</h1>
        <p class="app-subtitle">Real-time messaging powered by Redis</p>
      </div>

      <!-- Name Field -->
      <div class="form-group">
        <div class="input-container">
          <div class="input-label">Name</div>
          <input type="text" class="form-input read-only" placeholder="Name" id="name" th:value="${username}" readonly>
        </div>
      </div>

      <!-- Room Field -->
      <div class="form-group">
        <div class="input-container">
          <div class="input-label">Room</div>
          <input type="text" class="form-input" placeholder="Room" id="room" th:value="${defaultRoom}">
        </div>
      </div>

      <div class="form-group" id="start-control">
        <button class="btn" type="button" id="start">Start</button>
      </div>

      <div id="chat-div" class="chat-area">
        <label for="history" class="chat-messages-label">Messages</label>
        <div class="chat-messages" id="history">
          <!-- Messages will be added here dynamically -->
        </div>

        <div class="message-input-container">
          <input type="text" class="message-input" placeholder="Type your message here" id="message">
          <button class="btn send-btn" type="button" id="send" disabled>Send</button>
        </div>
      </div>
      
      <footer class="chat-footer">
        <p>Created by <a href="http://www.pavelkostal.com" target="_blank">Pavel Kostal</a> &copy; 2025</p>
      </footer>
    </div>

    <script type="text/javascript" th:inline="javascript">
        const username = /*[[${username}]]*/ 'default-user';
        console.log(username);

        const roomInput = document.getElementById('room');
        const messageInput = document.getElementById('message');

        roomInput.addEventListener('input', function () {
            const startButton = document.getElementById('start');
            startButton.disabled = !roomInput.value.trim();
        });

        messageInput.addEventListener('input', function () {
            const sendButton = document.getElementById('send');
            sendButton.disabled = !roomInput.value.trim();
        });

        // will be executed after pressing start button
        const chatFunction = () => {
            const name = document.getElementById('name').value;
            const room = document.getElementById('room').value;
            const history = document.getElementById('history');
            const message = document.getElementById('message');
            const send = document.getElementById('send');
            const chatDiv = document.getElementById('chat-div');
            const startControl = document.getElementById('start-control');

            chatDiv.classList.add('visible');
            startControl.style.display = 'none';

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const uri = `${protocol}//${window.location.hostname}:${window.location.port}/chat?room=${room}`;
            const websocket = new WebSocket(uri);

            websocket.onmessage = (evt) => {
                let obj = JSON.parse(evt.data);
                let ele = document.createElement("p");
                ele.className = 'message';

                if (obj.sender === username) {
                    ele.classList.add('user-message');
                }

                ele.innerHTML = `<b>${obj.sender}:</b>&nbsp;${obj.message}`;
                history.appendChild(ele);
                history.scrollTop = history.scrollHeight; // Auto-scroll to bottom
            }

            websocket.onopen = () => {
                let ele = document.createElement("p");
                ele.className = 'system-message';
                ele.innerHTML = `<b>CONNECTED</b>`;
                history.appendChild(ele);
            }

            websocket.onclose = () => {
                let ele = document.createElement("p");
                ele.className = 'system-message';
                ele.innerHTML = `<b>DISCONNECTED</b>`;
                history.appendChild(ele);
            }

            const sendMessage = () => {
                if (!message.value.trim()) return;
                
                let obj = {
                    sender: name,
                    message: message.value
                }
                message.value = '';
                websocket.send(JSON.stringify(obj));
                message.focus();
            }
            
            send.addEventListener('click', sendMessage);
            
            // Add the ability to send a message with an Enter key
            message.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }

        document.getElementById('start').addEventListener('click', chatFunction);
    </script>
  </body>
</html>